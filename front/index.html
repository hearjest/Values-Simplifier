<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Upload</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="authContainer" class="container">
        <h1>Login</h1>
        <form id="loginForm">
            <input type="text" id="loginUsername" placeholder="Username" required autocomplete="on">
            <input type="password" id="loginPassword" placeholder="Password" required autocomplete="current-password">
            <button type="submit">Login</button>
        </form>
        <p>Don't have an account? <a href="#" id="showRegister">Register</a></p>

        <form id="registerForm" style="display:none;">
            <h1>Register</h1>
            <input type="text" id="regUsername" placeholder="Username" required>
            <input type="password" id="regPassword" placeholder="Password" required autocomplete="new-password">
            <button type="submit">Register</button>
        </form>
        <p style="display:none;"><a href="#" id="showLogin">Back to Login</a></p>
        <div id="authMessage" class="message"></div>
    </div>

    <div id="imgCloseUp" style="display:none;">
        <img src="//:0" id="closeUp" style="display:none;">
    </div>

    <div id="uploadContainer" class="container" style="display:none;">
        <div class="header-with-logout">
            <h1>File Upload</h1>
            <button type="button" id="logoutBtn">Logout</button>
        </div>
        <div class="main-layout">
            <div class="upload-section">
                <form id="uploadForm" enctype="multipart/form-data">
                    <div class="upload-area">
                        <label for="fileInput" class="file-label">
                            <span class="upload-text">Choose a file or drag it here</span>
                        </label>
                        <input type="file" id="fileInput" name="img" required>
                    </div>
                    <label for="method">Method:</label>
                    <select id="method" name="method" required>
                        <option value="kMeans" selected>kMeans</option>
                        <option value="jobtype2">jobtype2</option>
                        <option value="jobtype3">jobtype3</option>
                    </select>
                    <button type="submit" class="upload-btn">Upload File</button>
                </form>
                <button type="button" id="getFilesBtn" class="upload-btn">Get Files</button>
                <div id="message" class="message"></div>
            </div>
            <div class="images-section">
                <h2>Processed Images</h2>
                <div id="imgBox"></div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const authContainer=document.getElementById('authContainer');
        const uploadContainer=document.getElementById('uploadContainer');
        const loginForm=document.getElementById('loginForm');
        const registerForm=document.getElementById('registerForm');
        const authMessage=document.getElementById('authMessage');
        const showRegister=document.getElementById('showRegister');
        const showLogin=document.getElementById('showLogin');
        const logoutBtn=document.getElementById('logoutBtn');
        const closeUpBackground=document.getElementById('imgCloseUp');
        const closeUpImg=document.getElementById('closeUp')
        checkAuthStatus();

        async function checkAuthStatus(){
            try {
                const res=await fetch('/api/checkToken',{
                    method:'GET',
                    credentials: 'include'
                });
                if (res.ok) {
                    const result=await res.json();
                    if (result.success) {
                        await showUploadSection();
                    }
                }
            }catch(error){
                console.log(error)
            }
        }

        showRegister.addEventListener('click', (e) => {
            e.preventDefault();
            loginForm.style.display='none';
            showRegister.parentElement.style.display='none';
            registerForm.style.display='block';
            showLogin.parentElement.style.display='block';
        });

        showLogin.addEventListener('click', (e) => {
            e.preventDefault();
            registerForm.style.display='none';
            showLogin.parentElement.style.display='none';
            loginForm.style.display='block';
            showRegister.parentElement.style.display='block';
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const userName=document.getElementById('loginUsername').value;
            const password=document.getElementById('loginPassword').value;

            try {
                const response=await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ userName, password })
                });

                const result=await response.json();
                if (response.ok && result.success) {
                    await showUploadSection();
                } else {
                    authMessage.textContent=result.message || 'Login failed';
                    authMessage.className='message error';
                }
            } catch (error) {
                authMessage.textContent='Login error';
                authMessage.className='message error';
            }
        });

        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const userName=document.getElementById('regUsername').value;
            const password=document.getElementById('regPassword').value;

            try {
                const response=await fetch('/api/reg', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ userName, password })
                });

                const result=await response.json();
                if (response.ok && result.success) {
                    authMessage.textContent='Registered! Please login.';
                    authMessage.className='message success';
                    setTimeout(() => showLogin.click(), 1500);
                } else {
                    authMessage.textContent=result.message || 'Registration failed';
                    authMessage.className='message error';
                }
            } catch (error) {
                authMessage.textContent='Registration error';
                authMessage.className='message error';
            }
        });

        logoutBtn.addEventListener('click', async () => {
            try {
                await fetch('/api/logout', {
                    method: 'POST',
                    credentials: 'include'
                });
            } catch (error) {
                console.error('Logout error:', error);
            }
            authContainer.style.display='block';
            uploadContainer.style.display='none';
        });
        closeUpBackground.addEventListener('click',()=>{
                    closeUpBackground.style.display='none';
                    closeUpImg.style.display='none';
                })
        closeUp.addEventListener('click',()=>{
            window.open(closeUp.src)
        })

        async function createImgMenuOptions(){
            let button=document.createElement('button')
            button.type="button";
            button.addEventListener('click',()=>{

            })
        }  

        function addImgToBox(imgBox,link){
            let container=document.createElement('div');
            container.className='image-container'
            let img=document.createElement('img');
            img.src=link
            img.addEventListener('click',()=>{
                closeUpBackground.style.display='flex'
                closeUpBackground.style.width='100%';
                closeUpImg.style.display='block';
                closeUpImg.src=link;
                closeUpImg.target="_blank"
            })
            let optionsDiv=document.createElement('div');
            optionsDiv.className='image-options';
            let optionsBtn=document.createElement('button');
            optionsBtn.className='options-btn';
            optionsBtn.innerHTML='â‹®';
            optionsBtn.type='button';
            let menu=document.createElement('div');
            menu.className='options-menu';
            let downloadBtn=document.createElement('button');
            downloadBtn.className='menu-item';
            downloadBtn.textContent='Download';
            downloadBtn.onclick=() => {
                window.open(link, '_blank');
                menu.classList.remove('show');
            };
            let deleteBtn=document.createElement('button');
            deleteBtn.className='menu-item';
            deleteBtn.textContent='Delete';
            deleteBtn.onclick=async () => {
                let fileName=(link.split("http://localhost:9000/processed/"))[1]
                console.log(fileName)
                let res = await fetch("/api/removeImage",{
                    method:"POST",
                    headers:{'Content-Type': 'application/json' },
                    body:JSON.stringify({fileName:fileName}),
                    credentials:"include",
                })
                if(res.ok){
                    container.remove()
                }
            };
            menu.append(downloadBtn, deleteBtn);
            optionsDiv.append(optionsBtn, menu);
            optionsBtn.onclick=(e) => {
                e.stopPropagation();
                document.querySelectorAll('.options-menu.show').forEach(m => {
                    if (m !== menu) m.classList.remove('show');
                });
                menu.classList.toggle('show');
            };
            document.addEventListener('click', (e) => {
                if (!container.contains(e.target)) {
                    menu.classList.remove('show');
                }
            });
            container.append(optionsDiv,img);
            imgBox.append(container);
        }

        async function loadUserImages() {
            try {
                const response=await fetch('/api/getFiles', {
                    method: 'GET',
                    credentials: 'include'
                });
                const res=await response.json();
                let imgBox=document.getElementById('imgBox');
                imgBox.innerHTML='';
                if (res.result && res.result.length > 0) {
                    for (let i=0; i < res.result.length; i++) {
                        const link=res.result[i];
                        addImgToBox(imgBox, link);
                    }
                }
            } catch (error) {
                console.error('Error loading images:', error);
            }
        }
        const getFilesBtn=document.getElementById('getFilesBtn');
        getFilesBtn.addEventListener('click', loadUserImages);

        async function showUploadSection() {
            authContainer.style.display='none';
            uploadContainer.style.display='block';
            await loadUserImages();
        }

        

        const socket=io();
        socket.on("completed",({jobId, url})=>{
                        console.log(" got job " + jobId + " completed")
                        console.log("job url is ", url)
                        const img=document.createElement('img'); img.src=url;
                        uploadContainer.append(img)
                        let imgBox=document.getElementById('imgBox')
                        addImgToBox(imgBox,url)
        })
        const form=document.getElementById('uploadForm');
        const fileInput=document.getElementById('fileInput');
        const message=document.getElementById('message');
        const uploadText=document.querySelector('.upload-text');
        
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                uploadText.textContent=e.target.files[0].name;
            } else {
                uploadText.textContent='Choose a file or drag it here';
            }
        });
        
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData=new FormData(form);
            
            try {
                const response=await fetch('/api/upload', {
                    method: 'POST',
                    credentials: 'include',
                    body: formData
                });
                
                const result=await response.json();
                if (response.ok) {
                    message.textContent=result.message;
                    message.className='message success';
                    socket.emit("subTo",result.jobId)
                    
                } else {
                    message.textContent=result.message || 'Upload failed';
                    message.className='message error';
                }
            } catch (error) {
                message.textContent='An error occurred while uploading the file';
                message.className='message error';
            }
        });
        
    </script>
</body>
</html>
